# Dr.aiVOSS å‘é‡åŒ–æ•°æ®æ¶æ„è®¾è®¡

| ç‰ˆæœ¬å· | åˆ›å»ºæ—¶é—´ | æ›´æ–°æ—¶é—´ | æ–‡æ¡£ä¸»é¢˜ | åˆ›å»ºäºº |
|--------|----------|----------|----------|--------|
| v1.0   | 2026-02-05 | 2026-02-05 | Dr.aiVOSS å‘é‡åŒ–æ•°æ®æ¶æ„è®¾è®¡ | Randy Luo |

---

## ğŸ“‹ å˜æ›´æ—¥å¿— (Changelog)

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | å½±å“èŒƒå›´ |
|------|------|---------|---------|
| 2026-02-05 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®šä¹‰å‘é‡åŒ–æ•°æ®æ¶æ„ | æ–°å¢åŠŸèƒ½ |

---

## 1. è®¾è®¡æ¦‚è¿° {#overview}

### 1.1 æ ¸å¿ƒç›®æ ‡

Dr.aiVOSS å‘é‡åŒ–æ¶æ„æœåŠ¡äºä¸¤ä¸ªæ ¸å¿ƒä¸šåŠ¡åœºæ™¯ï¼š

| åœºæ™¯ | è¯´æ˜ | ä¸šåŠ¡ä»·å€¼ |
|------|------|----------|
| **ç‰©æ–™æ¸…æ´—åŒ¹é…** | å½“ VM ä¸Šä¼  BOM æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å°† `PA66-GF30 Housing` åŒ¹é…åˆ°æ ‡å‡†åº“ä¸­çš„ `Housing, Polyamide 66 30% GF` | å‡å°‘äººå·¥æ ¸å¯¹å·¥ä½œé‡ï¼Œæå‡åŒ¹é…å‡†ç¡®ç‡ |
| **äº§å“å¤ç”¨æ£€ç´¢** | å½“æ–°é¡¹ç›®è¿›æ¥æ—¶ï¼Œæ ¹æ® BOM ç»“æ„å¿«é€Ÿæ‰¾åˆ°å†å²ç›¸ä¼¼é¡¹ç›®ï¼Œå¤ç”¨å…¶å·¥è‰ºè·¯çº¿å’Œ MHR | ç¼©çŸ­æ–°é¡¹ç›®æŠ¥ä»·å‘¨æœŸï¼Œä¿è¯æˆæœ¬ä¸€è‡´æ€§ |

### 1.2 åŒç´¢å¼•ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‘é‡åŒ–æ•°æ®æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å¾®è§‚å±‚ï¼šå•ç‰©æ–™      â”‚      â”‚  å®è§‚å±‚ï¼šäº§å“æŒ‡çº¹    â”‚      â”‚
â”‚  â”‚  Material Embedding â”‚      â”‚  Product Fingerprintâ”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ â€¢ name              â”‚      â”‚ â€¢ product_name      â”‚      â”‚
â”‚  â”‚ â€¢ material          â”‚      â”‚ â€¢ å…³é”®ç»„ä»¶åˆ—è¡¨       â”‚      â”‚
â”‚  â”‚ â€¢ remarks           â”‚      â”‚ â€¢ å·¥è‰ºåç§°åºåˆ—       â”‚      â”‚
â”‚  â”‚ â€¢ material_type     â”‚      â”‚ â€¢ å·¥è‰ºç‰¹å¾å…³é”®è¯     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â†“                             â†“                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  material_vectors   â”‚      â”‚  product_vectors    â”‚      â”‚
â”‚  â”‚  (ç‰©æ–™æ¸…æ´—åŒ¹é…)      â”‚      â”‚  (å†å²æ–¹æ¡ˆå¤ç”¨)      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ä¸šåŠ¡åœºæ™¯ {#business-scenarios}

### 2.1 ç‰©æ–™æ¸…æ´—åŒ¹é… {#material-matching}

**è§¦å‘æ—¶æœº**ï¼šVM ä¸Šä¼  Excel BOM æ–‡ä»¶å

**ä¸šåŠ¡æµç¨‹**ï¼š
```
1. ç³»ç»Ÿè§£æ BOMï¼Œæå–ç‰©æ–™ä¿¡æ¯
2. å°è¯•ç²¾ç¡®åŒ¹é…ï¼ˆç‰©æ–™å·å®Œå…¨ä¸€è‡´ï¼‰
   â”œâ”€ åŒ¹é…æˆåŠŸ â†’ ğŸŸ¢ Green çŠ¶æ€
   â””â”€ åŒ¹é…å¤±è´¥ â†“
3. æ‰§è¡Œå‘é‡è¯­ä¹‰æœç´¢
   â”œâ”€ ç›¸ä¼¼åº¦ > 85% â†’ ğŸŸ¡ Yellow çŠ¶æ€ï¼ˆéœ€äººå·¥ç¡®è®¤ï¼‰
   â””â”€ ç›¸ä¼¼åº¦ â‰¤ 85% â†’ ğŸ”´ Red çŠ¶æ€ï¼ˆéœ€äººå·¥è¾“å…¥ï¼‰
```

**ç¤ºä¾‹**ï¼š
| BOM ä¸­çš„ç‰©æ–™ | æ ‡å‡†åº“åŒ¹é…ç»“æœ | ç›¸ä¼¼åº¦ | çŠ¶æ€ |
|-------------|---------------|--------|------|
| `PA66-GF30 Housing` | `Housing, Polyamide 66 30% GF` | 92% | ğŸŸ¡ å¾…ç¡®è®¤ |
| `Steel Tube 6mm` | `Steel Tube 6mm DIN 2391` | 100% | ğŸŸ¢ è‡ªåŠ¨é€šè¿‡ |
| `XYZ-123 Custom Part` | æ— åŒ¹é…ç»“æœ | - | ğŸ”´ å¾…è¾“å…¥ |

### 2.2 äº§å“å¤ç”¨æ£€ç´¢ {#product-reuse}

**è§¦å‘æ—¶æœº**ï¼šåˆ›å»ºæ–°é¡¹ç›®ï¼Œæ·»åŠ äº§å“å

**ä¸šåŠ¡æµç¨‹**ï¼š
```
1. ç³»ç»Ÿæ ¹æ®æ–°äº§å“çš„ BOM ç»“æ„ç”ŸæˆæŒ‡çº¹å‘é‡
2. åœ¨å†å²äº§å“å‘é‡åº“ä¸­æœç´¢ç›¸ä¼¼äº§å“
3. è¿”å› Top 3 ç›¸ä¼¼äº§å“åŠä»¥ä¸‹ä¿¡æ¯ï¼š
   â€¢ ç›¸ä¼¼åº¦è¯„åˆ†
   â€¢ å†å²å·¥è‰ºè·¯çº¿
   â€¢ æ ‡å‡† MHR å‚è€ƒ
   â€¢ æˆæœ¬ç»“æ„å¯¹æ¯”
4. VM å¯é€‰æ‹©å¤ç”¨å†å²å·¥è‰ºè·¯çº¿
```

**ç¤ºä¾‹**ï¼š
| æ–°äº§å“ | Top 1 ç›¸ä¼¼äº§å“ | ç›¸ä¼¼åº¦ | å¯å¤ç”¨ä¿¡æ¯ |
|--------|---------------|--------|-----------|
| `Front Brake Line Assy` | `Brake Line Assembly - 2024-Q1` | 89% | å·¥è‰ºè·¯çº¿ã€MHR è´¹ç‡ |
| `Rear Suspension Arm` | `Suspension Arm - 2023-Q4` | 76% | éƒ¨åˆ†å·¥åºå‚è€ƒ |

---

## 3. å‘é‡è¡¨è®¾è®¡ {#vector-tables}

> **æŠ€æœ¯æ ˆ**ï¼šPostgreSQL 16 + pgvector æ‰©å±•
> **å‘é‡ç»´åº¦**ï¼š1536ï¼ˆOpenAI text-embedding-ada-002ï¼‰æˆ–æ ¹æ®æ¨¡å‹è°ƒæ•´
> **ç›¸ä¼¼åº¦è®¡ç®—**ï¼šä½™å¼¦è·ç¦»ï¼ˆCosine Distanceï¼‰

### 3.1 material_vectorsï¼ˆç‰©æ–™å‘é‡è¡¨ï¼‰{#material-vectors}

**ç”¨é€”**ï¼šå­˜å‚¨ç‰©æ–™ä¸»æ•°æ®çš„è¯­ä¹‰å‘é‡ï¼Œç”¨äº BOM ç‰©æ–™æ¸…æ´—åŒ¹é…

#### è¡¨ç»“æ„

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | CHAR(36) | PK | UUID |
| material_id | VARCHAR(50) | FK, NOT NULL, UNIQUE | å…³è” materials.id |
| embedding | vector(1536) | NOT NULL | ç‰©æ–™è¯­ä¹‰å‘é‡ |
| embedding_text | TEXT | NOT NULL | ç”¨äºç”Ÿæˆå‘é‡çš„æ±‡é›†æ–‡æœ¬ï¼ˆå¿«ç…§ï¼‰ |
| embedding_model | VARCHAR(50) | DEFAULT 'text-embedding-ada-002' | ä½¿ç”¨çš„åµŒå…¥æ¨¡å‹ |
| similarity_threshold | DECIMAL(3,2) | DEFAULT 0.85 | ç›¸ä¼¼åº¦é˜ˆå€¼ |
| created_at | DATETIME | DEFAULT NOW() | |
| updated_at | DATETIME | ON UPDATE NOW() | |

#### å¤–é”®å…³ç³»
```sql
ALTER TABLE material_vectors
ADD CONSTRAINT fk_mv_material
FOREIGN KEY (material_id) REFERENCES materials(id)
ON DELETE CASCADE;
```

#### ç´¢å¼•è®¾è®¡
```sql
-- pgvector HNSW ç´¢å¼•ï¼ˆé«˜æ€§èƒ½è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼‰
CREATE INDEX idx_mv_embedding_hnsw
ON material_vectors USING hnsw (embedding vector_cosine_ops);

-- ç‰©æ–™ ID ç´¢å¼•
CREATE INDEX idx_mv_material_id ON material_vectors(material_id);
```

#### ç¤ºä¾‹æ•°æ®
| material_id | embedding_text |
|-------------|----------------|
| `MAT-001` | `Name: Housing; Material: Polyamide 66 30% Glass Fiber; Type: Made; Remarks: High temp resistance` |
| `MAT-002` | `Name: Steel Tube; Material: Stainless Steel 304; Type: Bought; Remarks: DIN 2391 standard` |

---

### 3.2 product_vectorsï¼ˆäº§å“å‘é‡è¡¨ï¼‰{#product-vectors}

**ç”¨é€”**ï¼šå­˜å‚¨äº§å“ BOM æŒ‡çº¹å‘é‡ï¼Œç”¨äºå†å²ç›¸ä¼¼äº§å“æ£€ç´¢

#### è¡¨ç»“æ„

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | CHAR(36) | PK | UUID |
| product_id | CHAR(36) | FK, NOT NULL, UNIQUE | å…³è” project_products.id |
| embedding | vector(1536) | NOT NULL | äº§å“æŒ‡çº¹å‘é‡ |
| fingerprint_text | TEXT | NOT NULL | ç”¨äºç”Ÿæˆå‘é‡çš„æ±‡é›†æ–‡æœ¬ï¼ˆå¿«ç…§ï¼‰ |
| embedding_model | VARCHAR(50) | DEFAULT 'text-embedding-ada-002' | ä½¿ç”¨çš„åµŒå…¥æ¨¡å‹ |
| similarity_threshold | DECIMAL(3,2) | DEFAULT 0.80 | ç›¸ä¼¼åº¦é˜ˆå€¼ |
| created_at | DATETIME | DEFAULT NOW() | |
| updated_at | DATETIME | ON UPDATE NOW() | |

#### å¤–é”®å…³ç³»
```sql
ALTER TABLE product_vectors
ADD CONSTRAINT fk_pv_product
FOREIGN KEY (product_id) REFERENCES project_products(id)
ON DELETE CASCADE;
```

#### ç´¢å¼•è®¾è®¡
```sql
-- pgvector HNSW ç´¢å¼•
CREATE INDEX idx_pv_embedding_hnsw
ON product_vectors USING hnsw (embedding vector_cosine_ops);

-- äº§å“ ID ç´¢å¼•
CREATE INDEX idx_pv_product_id ON product_vectors(product_id);
```

#### ç¤ºä¾‹æ•°æ®
| product_id | fingerprint_text |
|------------|------------------|
| `PROD-001` | `Product: Front Brake Line Assy. Key Components: [Steel Tube 6mm, M12 Connector, Rubber Hose]. Process Flow: [Cutting, CNC Bending, End Forming, Manual Assembly, Leak Testing]. Features: [Zinc Coating, 3000bar pressure test]` |

---

## 4. å­—æ®µæ±‡é›†è§„åˆ™ {#field-aggregation}

> âš ï¸ **å…³é”®åŸåˆ™**ï¼šä¸è¦æŠŠæ•´ä¸ª JSON æ ‘ä¸¢è¿›å»ã€‚åªä¿ç•™è¯­ä¹‰ç›¸å…³çš„æ ¸å¿ƒå­—æ®µï¼Œæ’é™¤æ•°å€¼å‹å™ªéŸ³ã€‚

### 4.1 ç‰©æ–™å±‚æ±‡é›†ç­–ç•¥ {#material-aggregation}

**æ•°æ®æºè¡¨**ï¼š`materials`ï¼ˆç‰©æ–™ä¸»æ•°æ®è¡¨ï¼‰

#### åŒ…å«å­—æ®µï¼ˆè¯­ä¹‰ç›¸å…³ï¼‰

| æ ¸å¿ƒå­—æ®µ | å­—æ®µå (DB) | æƒé‡ | å¤„ç†æ–¹å¼ |
|:---|:---|:---|:---|
| **ç‰©æ–™åç§°** | `name` | â­â­â­ æœ€é«˜ | æ”¾åœ¨æ–‡æœ¬é¦–éƒ¨ï¼Œä½œä¸ºæ ¸å¿ƒæ ‡è¯† |
| **ææ–™æè¿°** | `material` | â­â­ é«˜ | ä½œä¸ºè¡¥å……æè¿°ï¼Œå†³å®šç‰©ç†å±æ€§ |
| **å¤‡æ³¨/è§„æ ¼** | `remarks` | â­â­ é«˜ | æå–å·¥è‰ºæš—ç¤ºï¼ˆå¦‚"é•€é”Œ"ã€"çƒ­å¤„ç†"ï¼‰ |
| **ç‰©æ–™ç±»å‹** | `material_type` | â­ ä¸­ | è¾…åŠ©ä¸Šä¸‹æ–‡ï¼Œé¿å…è·¨ç±»å‹é”™è¯¯åŒ¹é… |

#### æ’é™¤å­—æ®µï¼ˆå™ªéŸ³ï¼‰

| å­—æ®µ | æ’é™¤ç†ç”± |
|:---|:---|
| `id`, `created_at`, `updated_at` | æ— è¯­ä¹‰æ„ä¹‰ |
| `std_price` | ä»·æ ¼éšå¸‚åœºæ³¢åŠ¨ï¼Œä½†ç‰©æ–™ç‰©ç†å±æ€§ä¸å˜ã€‚**ä¸è¦è®©ä»·æ ¼å½±å“ç›¸ä¼¼åº¦åŒ¹é…** |
| `supplier` | ä¾›åº”å•†ä¿¡æ¯ä¸å½±å“ç‰©æ–™æœ¬èº«çš„ç‰©ç†å±æ€§ |
| `quantity` | æ•°é‡æ˜¯äº¤æ˜“å±æ€§ï¼Œä¸æ˜¯ç‰©æ–™å±æ€§ |

#### æ±‡é›†å‡½æ•°ç¤ºä¾‹

```python
def create_material_embedding_text(row: dict) -> str:
    """
    ä¸ºç‰©æ–™ç”Ÿæˆç”¨äº Embedding çš„æ–‡æœ¬

    Args:
        row: materials è¡¨çš„ä¸€è¡Œæ•°æ®

    Returns:
        æ±‡é›†åçš„æ–‡æœ¬
    """
    parts = []

    # æ ¸å¿ƒæ ‡è¯†ï¼ˆæœ€é«˜æƒé‡ï¼‰
    if row.get('name'):
        parts.append(f"Name: {row['name']}")

    # ææ–™æè¿°
    if row.get('material'):
        parts.append(f"Material: {row['material']}")

    # ç‰©æ–™ç±»å‹ï¼ˆè¾…åŠ©ä¸Šä¸‹æ–‡ï¼‰
    if row.get('material_type'):
        type_label = "Made" if row['material_type'] == 'made' else "Bought"
        parts.append(f"Type: {type_label}")

    # å¤‡æ³¨/è§„æ ¼
    if row.get('remarks'):
        parts.append(f"Remarks: {row['remarks']}")

    return "; ".join(parts)
```

#### æ±‡é›†æ–‡æœ¬ç¤ºä¾‹

```text
Name: Housing; Material: Polyamide 66 30% Glass Fiber; Type: Made; Remarks: High temp resistance, zinc plated
```

---

### 4.2 äº§å“å±‚æ±‡é›†ç­–ç•¥ {#product-aggregation}

**æ•°æ®æºè¡¨**ï¼š`project_products`ï¼ˆäº§å“å¤´ï¼‰ + `product_materials`ï¼ˆç»„ä»¶ï¼‰ + `product_processes`ï¼ˆå·¥è‰ºï¼‰

#### åŒ…å«å­—æ®µï¼ˆè¯­ä¹‰ç›¸å…³ï¼‰

| æ ¸å¿ƒç»´åº¦ | æ¥æºå­—æ®µ | æƒé‡ | æ±‡é›†ç­–ç•¥ |
|:---|:---|:---|:---|
| **äº§å“åç§°** | `project_products.product_name` | â­â­â­ | æä¾›é«˜å±‚çº§ä¸Šä¸‹æ–‡ |
| **å…³é”®ç»„ä»¶** | `product_materials.material_name` | â­â­â­ | **ä»… Level 1 çš„å…³é”®ç‰©æ–™**ï¼Œå¿½ç•¥æ ‡å‡†ä»¶ |
| **ä¸»å·¥è‰ºæµ** | `product_processes.process_name` | â­â­â­ | å»é‡åçš„å·¥è‰ºåç§°åºåˆ— |
| **å·¥è‰ºç‰¹å¾** | `product_materials.remarks` | â­â­ | æå– BOM ä¸­çš„å·¥è‰ºå…³é”®è¯ |

#### æ’é™¤å­—æ®µï¼ˆå™ªéŸ³ï¼‰

| å­—æ®µ | æ’é™¤ç†ç”± |
|:---|:---|
| `quantity` | æ•°é‡å·®å¼‚ï¼ˆ1ç±³ vs 1.2ç±³ï¼‰ä¸æ”¹å˜å·¥è‰ºè·¯çº¿æœ¬è´¨ |
| `product_code` | å®¢æˆ·é›¶ä»¶å·é€šå¸¸æ˜¯ä¹±ç æˆ–æ— è§„å¾‹æ•°å­— |
| `cycle_time_std` | å·¥æ—¶æ•°å€¼å·®å¼‚ä¸å½±å“å·¥è‰ºè·¯çº¿ç±»å‹ |
| `std_cost` | æˆæœ¬é‡‘é¢ä¸å½±å“å·¥è‰ºè·¯çº¿ç›¸ä¼¼åº¦ |

#### æ±‡é›†å‡½æ•°ç¤ºä¾‹

```python
def create_product_fingerprint(
    product_name: str,
    bom_rows: list[dict],
    process_rows: list[dict]
) -> str:
    """
    ä¸ºäº§å“ç”Ÿæˆç”¨äº Embedding çš„æŒ‡çº¹æ–‡æœ¬

    Args:
        product_name: äº§å“åç§°
        bom_rows: product_materials æ•°æ®
        process_rows: product_processes æ•°æ®

    Returns:
        æ±‡é›†åçš„æŒ‡çº¹æ–‡æœ¬
    """
    parts = []

    # äº§å“åç§°
    if product_name:
        parts.append(f"Product: {product_name}")

    # å…³é”®ç»„ä»¶ï¼ˆä»… Level 1ï¼Œè¿‡æ»¤ä½ä»·å€¼æ ‡å‡†ä»¶ï¼‰
    key_materials = []
    standard_part_keywords = ['screw', 'bolt', 'nut', 'washer', 'seal', 'o-ring']

    for row in bom_rows:
        # ä»… Level 1 ç‰©æ–™
        if row.get('material_level') != 1:
            continue

        # æ’é™¤æ ‡å‡†ä»¶
        material_name_lower = row.get('material_name', '').lower()
        if any(kw in material_name_lower for kw in standard_part_keywords):
            continue

        key_materials.append(row.get('material_name'))

    if key_materials:
        parts.append(f"Key Components: [{', '.join(key_materials)}]")

    # å·¥è‰ºæµï¼ˆå»é‡ï¼ŒæŒ‰é¡ºåºï¼‰
    process_flow = []
    seen_processes = set()

    for row in sorted(process_rows, key=lambda x: x.get('sequence_order', 0)):
        proc_name = row.get('process_name')
        if proc_name and proc_name not in seen_processes:
            process_flow.append(proc_name)
            seen_processes.add(proc_name)

    if process_flow:
        parts.append(f"Process Flow: [{', '.join(process_flow)}]")

    # å·¥è‰ºç‰¹å¾ï¼ˆä» BOM remarks æå–ï¼‰
    features = []
    for row in bom_rows:
        remarks = row.get('remarks', '')
        if remarks and any(kw in remarks.lower() for kw in ['weld', 'coat', 'test', 'heat']):
            features.append(remarks[:50])  # é™åˆ¶é•¿åº¦

    if features:
        parts.append(f"Features: [{', '.join(features)}]")

    return ". ".join(parts)
```

#### æ±‡é›†æ–‡æœ¬ç¤ºä¾‹

```text
Product: Front Brake Line Assy. Key Components: [Steel Tube 6mm, M12 Connector, Rubber Hose]. Process Flow: [Cutting, CNC Bending, End Forming, Manual Assembly, Leak Testing]. Features: [Zinc Coating, 3000bar pressure test]
```

---

## 5. å‘é‡ç´¢å¼•è®¾è®¡ {#index-design}

### 5.1 HNSW ç´¢å¼•å‚æ•°

**HNSWï¼ˆHierarchical Navigable Small Worldï¼‰** æ˜¯ pgvector æ¨èçš„ç´¢å¼•ç±»å‹ï¼Œå¹³è¡¡äº†æŸ¥è¯¢é€Ÿåº¦å’Œå‡†ç¡®ç‡ã€‚

```sql
-- ç‰©æ–™å‘é‡ç´¢å¼•
CREATE INDEX idx_mv_embedding_hnsw
ON material_vectors
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 16,        -- æ¯å±‚æœ€å¤šè¿æ¥æ•° (default: 16)
    ef_construction = 64  -- æ„å»ºæ—¶çš„å€™é€‰æ•° (default: 64)
);

-- äº§å“å‘é‡ç´¢å¼•
CREATE INDEX idx_pv_embedding_hnsw
ON product_vectors
USING hnsw (embedding vector_cosine_ops)
WITH (
    m = 16,
    ef_construction = 64
);
```

### 5.2 æŸ¥è¯¢å‚æ•°è°ƒä¼˜

```sql
-- è¿è¡Œæ—¶è®¾ç½® ef_sizeï¼ˆè¶Šå¤§è¶Šå‡†ç¡®ï¼Œä½†è¶Šæ…¢ï¼‰
SET hnsw.ef_search = 100;  -- default: 40

-- æŸ¥è¯¢ç¤ºä¾‹
SELECT material_id,
       1 - (embedding <=> :query_vector) AS similarity
FROM material_vectors
WHERE 1 - (embedding <=> :query_vector) > 0.85
ORDER BY similarity DESC
LIMIT 5;
```

---

## 6. API ç«¯ç‚¹å®šä¹‰ {#api-endpoints}

### 6.1 å‘é‡æœç´¢ - ç‰©æ–™

**POST** `/api/v1/vector/materials/search`

æœç´¢ä¸ç»™å®šæ–‡æœ¬è¯­ä¹‰ç›¸ä¼¼çš„ç‰©æ–™ã€‚

#### è¯·æ±‚ä½“
```json
{
  "query": "PA66-GF30 Housing",
  "limit": 5,
  "min_similarity": 0.85,
  "material_type_filter": "made"
}
```

#### å“åº”
```json
{
  "success": true,
  "data": {
    "query_embedding": [0.0123, ...],
    "results": [
      {
        "material_id": "MAT-001",
        "name": "Housing, Polyamide 66 30% GF",
        "material": "PA66-GF30",
        "std_price": 28.50,
        "similarity": 0.92,
        "match_type": "semantic"
      }
    ],
    "total_results": 3
  }
}
```

---

### 6.2 å‘é‡æœç´¢ - äº§å“

**POST** `/api/v1/vector/products/search`

æœç´¢ä¸ç»™å®š BOM ç»“æ„ç›¸ä¼¼çš„å†å²äº§å“ã€‚

#### è¯·æ±‚ä½“
```json
{
  "product_name": "Front Brake Line Assy",
  "bom_materials": [
    {"name": "Steel Tube 6mm", "level": 1},
    {"name": "M12 Connector", "level": 1}
  ],
  "processes": ["Cutting", "CNC Bending", "Assembly"],
  "limit": 3,
  "min_similarity": 0.80
}
```

#### å“åº”
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "product_id": "PROD-001",
        "project_name": "Brake Line Project 2024-Q1",
        "similarity": 0.89,
        "processes": ["Cutting", "CNC Bending", "End Forming", "Assembly"],
        "avg_mhr": 75.50
      }
    ],
    "total_results": 2
  }
}
```

---

### 6.3 åŒæ­¥å‘é‡ - ç‰©æ–™

**POST** `/api/v1/vector/materials/sync`

ä¸ºæŒ‡å®šç‰©æ–™ç”Ÿæˆ/æ›´æ–°å‘é‡åµŒå…¥ã€‚

#### è¯·æ±‚ä½“
```json
{
  "material_ids": ["MAT-001", "MAT-002"],
  "force_rebuild": false
}
```

#### å“åº”
```json
{
  "success": true,
  "data": {
    "synced": 2,
    "failed": 0,
    "details": [
      {"material_id": "MAT-001", "status": "created"},
      {"material_id": "MAT-002", "status": "updated"}
    ]
  }
}
```

---

### 6.4 åŒæ­¥å‘é‡ - äº§å“

**POST** `/api/v1/vector/products/sync`

ä¸ºæŒ‡å®šäº§å“ç”Ÿæˆ/æ›´æ–°æŒ‡çº¹å‘é‡ã€‚

#### è¯·æ±‚ä½“
```json
{
  "product_ids": ["PROD-001"],
  "force_rebuild": false
}
```

#### å“åº”
```json
{
  "success": true,
  "data": {
    "synced": 1,
    "failed": 0,
    "details": [
      {"product_id": "PROD-001", "status": "updated"}
    ]
  }
}
```

---

## 7. å®ç°å»ºè®® {#implementation}

### 7.1 Embedding æ¨¡å‹é€‰æ‹©

| æ¨¡å‹ | ç»´åº¦ | è¯­è¨€ | æ¨è |
|------|------|------|------|
| **text-embedding-ada-002** | 1536 | å¤šè¯­è¨€ | â­â­â­ æ¨è |
| **é€šä¹‰åƒé—® Embedding** | 1024 | ä¸­è‹± | â­â­ å¤‡é€‰ |
| **bge-large-zh** | 1024 | ä¸­æ–‡ | â­ å¤‡é€‰ |

### 7.2 æ•°æ®åŒæ­¥ç­–ç•¥

```python
# ä¼ªä»£ç ï¼šå¼‚æ­¥å‘é‡åŒæ­¥
@receiver(post_save, sender=Material)
def sync_material_vector(sender, instance, created, **kwargs):
    """ç‰©æ–™ä¿å­˜åå¼‚æ­¥ç”Ÿæˆå‘é‡"""
    if created or instance.has_tracked_changes():
        async_task(
            'vector.sync_material',
            material_id=instance.id
        )

@receiver(post_save, sender=ProductMaterial)
@receiver(post_save, sender=ProductProcess)
def sync_product_fingerprint(sender, instance, **kwargs):
    """BOM æˆ–å·¥è‰ºå˜æ›´åé‡æ–°ç”Ÿæˆäº§å“æŒ‡çº¹"""
    async_task(
        'vector.sync_product',
        product_id=instance.project_product_id
    )
```

### 7.3 ç¼“å­˜ç­–ç•¥

| ç¼“å­˜é”® | TTL | è¯´æ˜ |
|--------|-----|------|
| `vector:search:{hash}` | 10min | å‘é‡æ£€ç´¢ç»“æœ |
| `vector:embedding:{material_id}` | 24h | ç‰©æ–™å‘é‡åµŒå…¥ |
| `vector:fingerprint:{product_id}` | 24h | äº§å“æŒ‡çº¹å‘é‡ |

### 7.4 ç›‘æ§æŒ‡æ ‡

- å‘é‡ç”ŸæˆæˆåŠŸç‡ï¼ˆç›®æ ‡ï¼š> 99%ï¼‰
- å¹³å‡æœç´¢å“åº”æ—¶é—´ï¼ˆç›®æ ‡ï¼š< 500msï¼‰
- ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç›®æ ‡ï¼š> 60%ï¼‰

---

## 8. å‚è€ƒæ–‡æ¡£

- [DATABASE_DESIGN.md](DATABASE_DESIGN.md) - æ•°æ®åº“ç»“æ„è®¾è®¡
- [API_REFERENCE.md](API_REFERENCE.md) - API å®Œæ•´å‚è€ƒ
- [PROJECT_CONTEXT.md](../PROJECT_CONTEXT.md) - ä¸šåŠ¡é€»è¾‘æ ¸å¿ƒå¥‘çº¦

---

**æ–‡æ¡£ç»“æŸ**
